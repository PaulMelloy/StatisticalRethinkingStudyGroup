---
title: "Week4_Chapter3"
author: "P. Melloy"
date: "25/08/2020"
output: html_document
---
```{r message=FALSE, warning=FALSE}
library(rethinking)
```

```{r}
Pr_Positive_Vampire <- 0.95
Pr_Positive_Mortal <- 0.01
Pr_Vampire <- 0.001
Pr_Positive <- Pr_Positive_Vampire * Pr_Vampire +
Pr_Positive_Mortal * ( 1 - Pr_Vampire )
( Pr_Vampire_Positive <- Pr_Positive_Vampire*Pr_Vampire / Pr_Positive )
```

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prob_p <- rep( 1 , 1000 )
prob_data <- dbinom( 6 , size=9 , prob=p_grid )
posterior <- prob_data * prob_p
posterior <- posterior / sum(posterior)
```


```{r}
samples <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE )
plot(samples)
```

```{r}
dens(samples)
```

```{r}
# add up posterior probability where p < 0.5 
sum( posterior[ p_grid < 0.5 ] )

sum( samples < 0.5 ) / 1e4
```

```{r}
sum( samples > 0.5 & samples < 0.75 ) / 1e4
```

```{r 3.10}
quantile(samples, 0.8)
quantile(samples, c(0.1,0.9))
```

```{r 3.11}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prior <- rep(1,1000)
likelihood <- dbinom( 3 , size=3 , prob=p_grid )
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
samples <- sample( p_grid , size=1e4 , replace=TRUE , prob=posterior )
```

```{r 3.12}
PI(samples, prob = 0.5)
```

```{r 3.13}
HPDI( samples , prob=0.5 )
```


```{r}
dummy_w <- rbinom( 1e5 , size=9 , prob=0.7 )
simplehist( dummy_w , xlab="dummy water count" )
```





I recently had a discussion on facebook with a "friend" who claimed that excessive force by police was equally likely against people with black and white skin.
Knowing his circle of friends and the area in which he lived and visited growing up was predominantly white I could assume that the proportion of individuals he encountered was less than the National census of [0.033](https://www.aihw.gov.au/reports/australias-welfare/profile-of-indigenous-australians), however lets assume it was 0.1 (10%) and solve for this.  

So according to his prior assumptions on his opinion  
$Pr(black|ExcessiveForce) = 0.5$  
and therefore  
$Pr(ExcessiveForce|white) = 0.5$  
We will also assume:  
$Pr(black) \approx 0.1$  
I don't know the probability of excessive force but lets say its low at 1 in 100 cases.  
$Pr(ExcessiveForce) = Pr(ExcessiveForce|black)*Pr(black) + Pr(ExcessiveForce|white) + Pr(white)$
```{r}
paste("Pr(ExcessiveForce) =",
      (0.5*0.1) + (0.5 * (1- 0.1)))
```


So what is the probability someone who is black given the excessive use of force
$Pr(black|ExcessiveForce) = \frac{Pr(ExcessiveForce|black)*Pr(black)}{Pr(ExcessiveForce)}$

```{r}
paste("Pr(ExcessiveForce|black) =",
      (0.5 *0.1)/0.01)
```
So if excessive force is used there is a 10% chance the person is black

So what is the probability they are white given the excessive force
$Pr(white|ExcessiveForce) = \frac{Pr(ExcessiveForce|white)*Pr(white)}{Pr(ExcessiveForce)}$
```{r}
paste("Pr(white|ExcessiveForce) =",
      (0.5 *0.9)/0.5)
```



## Exercises  

**Easy.** These problems use the samples from the posterior distribution for the globe tossing example.
This code will give you a specific set of samples, so that you can check your answers exactly

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prior <- rep( 1 , 1000 )
likelihood <- dbinom( 6 , size=9 , prob=p_grid )
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
set.seed(100)
samples1 <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE )
```

Use the values in samples to answer the questions that follow.
3E1. How much posterior probability lies below p = 0.2?
```{r}
sum(samples1 < 0.2)/length(samples1)*100
sum(samples1 < 0.2)/1e4*100
```

3E2. How much posterior probability lies above p = 0.8?  
```{r}
sum(samples1 > 0.8)/length(samples1) * 100
```

3E3. How much posterior probability lies between p = 0.2 and p = 0.8?  
```{r}
sum(samples1[samples1 < 0.8 & 
       samples1 > 0.2])/length(samples1)
```

3E4. 20% of the posterior probability lies below which value of p?
```{r}
quantile(samples1,0.2)
1 - quantile(samples1,0.2)
```


3E5. 20% of the posterior probability lies above which value of p?
```{r}
quantile(samples1,0.8)
E5 <- quantile(samples1,c(0.8, 1))
E5[2]-E5[1]
```



3E6. Which values of p contain the narrowest interval equal to 66% of the posterior probability?
```{r}
HPDI(samples1, prob = 0.66)
```

3E7. Which values of p contain 66% of the posterior probability, assuming equal posterior probability
both below and above the interval?  
```{r}
PI(samples1, prob = 0.66)
```



### Medium.  
#### 3M1.  
Suppose the globe tossing data had turned out to be 8 water in 15 tosses. Construct the posterior
distribution, using grid approximation. Use the same flat prior as before.

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 ) # create a grid of all the possibilities
prior <- rep( 1 , 1000 )  # a prior which states all probabilities are equally likely
likelihood <- dbinom( 8 , size=15 , prob=p_grid ) # What is the likiehood of 8 outcomes from 15 samples given a probability of p_grid
posterior <- likelihood * prior  # "add" the likihood to the prior to find the posterier
posterior <- posterior / sum(posterior) # normalise the posterior
set.seed(100)
samples2 <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE ) # sample from all the possible probabilities 10k times with the probabilities in our posterier
```


#### 3M2.  
Draw 10,000 samples from the grid approximation from above. Then use the samples to calculate
the 90% HPDI for p.  
*-HPDI finds the most probable outcomes, and results in intervals which are shorter than any other intervals*
```{r}
HPDI(samples2, 0.9)
```


#### 3M3.  
Construct a posterior predictive check for this model and data. This means simulate the distribution
of samples, averaging over the posterior uncertainty in p. What is the probability of observing
8 water in 15 tosses?
```{r}
w <- rbinom(n = 1e5,        # randomly sample 10k samples
            size = 15,      # that have 15 trials
            prob = samples2) # with the probability of our sampled posterior

summary(w)                  # summarise the number of outcomes to trials there were
simplehist(w)               # show the number of outcomes to trials in a histogram

prob_8_15 <-                # What is the probability of 8 water (outcomes) from 15 tosses (trials)
   sum(w == 8)/length(w)    # sum the number of of w which equal 8 and divide by the total number of w's

paste(round(100*prob_8_15, 4),"%")    # show as a percentage
```


#### 3M4. 
Using the posterior distribution constructed from the new (8/15) data, now calculate the probability
of observing 6 water in 9 tosses.

```{r}
w <- rbinom(n = 1e5,        # randomly sample 10k samples
            size = 9,       # that have 9 trials
            prob = samples2) # with the probability of our sampled posterior

summary(w)                  # summarise the number of outcomes to trials there were
simplehist(w)               # show the number of outcomes to trials in a histogram

prob_6_9 <-                # What is the probability of 8 water (outcomes) from 15 tosses (trials)
   sum(w == 6)/length(w)    # sum the number of of w which equal 8 and divide by the total number of w's

paste(round(100*prob_6_9, 4),"%")    # show as a percentage
```

#### 3M5.  
Start over at 3M1, but now use a prior that is zero below p = 0.5 and a constant above p = 0.5.
This corresponds to prior information that a majority of the Earth’s surface is water. Repeat each
problem above and compare the inferences. What difference does the better prior make? If it helps,
compare inferences (using both priors) to the true value p = 0.7.

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 ) # create a grid of all the possibilities
prior <- as.numeric(p_grid > 0.5)  # a prior which states for the probabilities in p_grid, one above 0.5 are equally likely, while below ore impossible
likelihood <- dbinom( 8 , size=15 , prob=p_grid ) # What is the likiehood of 8 outcomes from 15 samples given a probability of p_grid
posterior <- likelihood * prior  # "add" the likihood to the prior to find the posterier
posterior <- posterior / sum(posterior) # normalise the posterior
set.seed(100)
samples3 <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE ) # sample from all the possible probabilities 10k times with the probabilities in our posterier
```

Draw 10,000 samples from the grid approximation from above. Then use the samples to calculate
the 90% HPDI for p.  

```{r}
HPDI(samples3, 0.9)
```

Construct a posterior predictive check for this model and data. This means simulate the distribution
of samples, averaging over the posterior uncertainty in p. What is the probability of observing
8 water in 15 tosses?  

```{r}
w <- rbinom(n = 1e5,        # randomly sample 10k samples
            size = 15,      # that have 15 trials
            prob = samples3) # with the probability of our sampled posterior

summary(w)                  # summarise the number of outcomes to trials there were
simplehist(w)               # show the number of outcomes to trials in a histogram

prob_8_15 <-                # What is the probability of 8 water (outcomes) from 15 tosses (trials)
   sum(w == 8)/length(w)    # sum the number of of w which equal 8 and divide by the total number of w's

paste(round(100*prob_8_15, 4),"%")    # show as a percentage
```

Using the posterior distribution constructed from the new (8/15) data, now calculate the probability
of observing 6 water in 9 tosses.  
```{r}
w <- rbinom(n = 1e5,        # randomly sample 10k samples
            size = 9,       # that have 9 trials
            prob = samples3) # with the probability of our sampled posterior

summary(w)                  # summarise the number of outcomes to trials there were
simplehist(w)               # show the number of outcomes to trials in a histogram

prob_6_9 <-                # What is the probability of 8 water (outcomes) from 15 tosses (trials)
   sum(w == 6)/length(w)    # sum the number of of w which equal 8 and divide by the total number of w's

paste(round(100*prob_6_9, 4),"%")    # show as a percentage
```

What is the likelihoods at 0.7 for samples1, samples2 and samples3
```{r}
quantile(samples2, 0.7)
quantile(samples3, 0.7)
# this is not complete
```



3M6. Suppose you want to estimate the Earth’s proportion of water very precisely. Specifically, you
want the 99% percentile interval of the posterior distribution of p to be only 0.05 wide. This means
the distance between the upper and lower bound of the interval should be 0.05. How many times will
you have to toss the globe to do this?













